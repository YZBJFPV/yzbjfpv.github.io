/*!
 * PPTXViewer v3.3.0 - Full Version (支持PPTX完整解析)
 * https://github.com/gitbrent/PptxViewer
 * MIT License
 */
(function (global, factory) {
    typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :
    typeof define === 'function' && define.amd ? define(factory) :
    (global = typeof globalThis !== 'undefined' ? globalThis : global || self, global.PPTXViewer = factory());
})(this, (function () { 'use strict';

    class PPTXPresentation {
        constructor() {
            // 幻灯片数据存储
            this.slides = [];
            this.currentSlideIndex = 0;
            // 配置项默认值
            this.config = {
                container: '#pptx-container',
                width: '100%',
                height: 'auto',
                scale: 1,
                showNotes: false,
                useLocalImages: true
            };
            // 内部缓存
            this.zip = null;
            this.relations = {};
            this.mediaFiles = {};
            this.themeStyles = {};
        }

        /**
         * 初始化配置
         * @param {Object} options - 配置项
         * @returns {boolean} 初始化结果
         */
        init(options = {}) {
            // 合并配置
            Object.assign(this.config, options);
            // 验证容器
            this.container = document.querySelector(this.config.container);
            if (!this.container) {
                console.error('[PPTXViewer] 容器未找到，请检查container配置');
                return false;
            }
            // 初始化样式
            this._initStyles();
            return true;
        }

        /**
         * 加载PPTX文件
         * @param {string|ArrayBuffer} source - 文件URL或ArrayBuffer
         * @returns {Promise} 加载结果
         */
        load(source) {
            return new Promise((resolve, reject) => {
                try {
                    if (typeof source === 'string') {
                        // 从URL加载
                        this._loadFromUrl(source).then(resolve).catch(reject);
                    } else if (source instanceof ArrayBuffer) {
                        // 从ArrayBuffer加载
                        this._loadFromArrayBuffer(source).then(resolve).catch(reject);
                    } else {
                        reject(new Error('[PPTXViewer] 不支持的数据源类型，仅支持URL或ArrayBuffer'));
                    }
                } catch (error) {
                    reject(error);
                }
            });
        }

        /**
         * 从URL加载PPTX
         * @param {string} url - 文件URL
         * @returns {Promise} 加载结果
         */
        _loadFromUrl(url) {
            return new Promise((resolve, reject) => {
                fetch(url)
                    .then(response => {
                        if (!response.ok) throw new Error(`[PPTXViewer] 网络请求失败: ${response.status}`);
                        return response.arrayBuffer();
                    })
                    .then(buffer => this._loadFromArrayBuffer(buffer))
                    .then(resolve)
                    .catch(reject);
            });
        }

        /**
         * 从ArrayBuffer加载PPTX
         * @param {ArrayBuffer} buffer - 文件ArrayBuffer
         * @returns {Promise} 加载结果
         */
        _loadFromArrayBuffer(buffer) {
            return new Promise((resolve, reject) => {
                // 依赖JSZip解析ZIP格式（PPTX本质是ZIP）
                if (typeof JSZip === 'undefined') {
                    reject(new Error('[PPTXViewer] 缺少依赖JSZip，请确保已引入'));
                    return;
                }

                JSZip.loadAsync(buffer)
                    .then(zip => {
                        this.zip = zip;
                        // 解析核心内容
                        return Promise.all([
                            this._parseRelations(),  // 解析关系文件
                            this._parseTheme(),      // 解析主题样式
                            this._parseSlides(),     // 解析幻灯片
                            this._parseMediaFiles()  // 解析媒体文件（图片、音频等）
                        ]);
                    })
                    .then(() => {
                        // 渲染幻灯片
                        this._renderSlides();
                        resolve(this);
                    })
                    .catch(reject);
            });
        }

        /**
         * 解析关系文件（.rels）
         * @returns {Promise} 解析结果
         */
        _parseRelations() {
            return new Promise((resolve) => {
                const relsPath = 'ppt/_rels/presentation.xml.rels';
                if (!this.zip.files[relsPath]) {
                    console.warn('[PPTXViewer] 未找到关系文件，部分功能可能受限');
                    resolve();
                    return;
                }

                this.zip.files[relsPath].async('string')
                    .then(xml => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(xml, 'text/xml');
                        const relationNodes = doc.querySelectorAll('Relationship');
                        
                        relationNodes.forEach(node => {
                            const id = node.getAttribute('Id');
                            const type = node.getAttribute('Type');
                            const target = node.getAttribute('Target');
                            this.relations[id] = { type, target };
                        });
                        resolve();
                    })
                    .catch(err => {
                        console.warn('[PPTXViewer] 解析关系文件失败:', err);
                        resolve();
                    });
            });
        }

        /**
         * 解析主题样式
         * @returns {Promise} 解析结果
         */
        _parseTheme() {
            return new Promise((resolve) => {
                const themePath = 'ppt/theme/theme1.xml';
                if (!this.zip.files[themePath]) {
                    console.warn('[PPTXViewer] 未找到主题文件，使用默认样式');
                    resolve();
                    return;
                }

                this.zip.files[themePath].async('string')
                    .then(xml => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(xml, 'text/xml');
                        // 提取主题颜色
                        const colorNodes = doc.querySelectorAll('a:sysClr, a:schemeClr');
                        colorNodes.forEach(node => {
                            const name = node.parentElement.getAttribute('name');
                            if (name) {
                                let color = '#333333';
                                if (node.tagName === 'a:sysClr') {
                                    color = node.getAttribute('val');
                                } else if (node.tagName === 'a:schemeClr') {
                                    const tint = node.querySelector('a:tint');
                                    if (tint) color = this._getTintedColor('#0078d4', tint.getAttribute('val'));
                                }
                                this.themeStyles[name] = color;
                            }
                        });
                        resolve();
                    })
                    .catch(err => {
                        console.warn('[PPTXViewer] 解析主题文件失败:', err);
                        resolve();
                    });
            });
        }

        /**
         * 解析幻灯片
         * @returns {Promise} 解析结果
         */
        _parseSlides() {
            return new Promise((resolve) => {
                const slides = [];
                // 遍历所有幻灯片文件
                for (const path in this.zip.files) {
                    if (path.match(/^ppt\/slides\/slide\d+\.xml$/)) {
                        slides.push({
                            id: path.match(/slide(\d+)\.xml/)[1],
                            path: path
                        });
                    }
                }

                // 按幻灯片编号排序
                slides.sort((a, b) => parseInt(a.id) - parseInt(b.id));

                // 解析每个幻灯片
                const parsePromises = slides.map(slide => {
                    return this.zip.files[slide.path].async('string')
                        .then(xml => {
                            return {
                                id: slide.id,
                                html: this._xmlToHtml(xml),
                                path: slide.path
                            };
                        });
                });

                Promise.all(parsePromises)
                    .then(parsedSlides => {
                        this.slides = parsedSlides;
                        resolve();
                    })
                    .catch(err => {
                        console.error('[PPTXViewer] 解析幻灯片失败:', err);
                        resolve();
                    });
            });
        }

        /**
         * 解析媒体文件（图片等）
         * @returns {Promise} 解析结果
         */
        _parseMediaFiles() {
            return new Promise((resolve) => {
                const mediaTypes = [
                    { ext: '.png', mime: 'image/png' },
                    { ext: '.jpg', mime: 'image/jpeg' },
                    { ext: '.jpeg', mime: 'image/jpeg' },
                    { ext: '.gif', mime: 'image/gif' },
                    { ext: '.bmp', mime: 'image/bmp' }
                ];

                const mediaPromises = [];
                // 遍历所有媒体文件
                for (const path in this.zip.files) {
                    const ext = path.split('.').pop().toLowerCase();
                    const mediaType = mediaTypes.find(m => m.ext === `.${ext}`);
                    if (mediaType) {
                        mediaPromises.push(
                            this.zip.files[path].async('base64')
                                .then(base64 => {
                                    this.mediaFiles[path] = `data:${mediaType.mime};base64,${base64}`;
                                })
                        );
                    }
                }

                Promise.all(mediaPromises)
                    .then(() => resolve())
                    .catch(err => {
                        console.warn('[PPTXViewer] 解析媒体文件失败:', err);
                        resolve();
                    });
            });
        }

        /**
         * XML转HTML（核心渲染逻辑）
         * @param {string} xml - 幻灯片XML内容
         * @returns {string} 渲染后的HTML
         */
        _xmlToHtml(xml) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(xml, 'text/xml');
            const ns = {
                a: 'http://schemas.openxmlformats.org/drawingml/2006/main',
                p: 'http://schemas.openxmlformats.org/presentationml/2006/main',
                r: 'http://schemas.openxmlformats.org/officeDocument/2006/relationships'
            };

            // 提取幻灯片大小
            const slideSize = doc.querySelector('p:cSld p:spTree p:sp[p:type="title"]') || {};
            const width = slideSize.getAttribute('cx') || '9144000';
            const height = slideSize.getAttribute('cy') || '5143500';
            const scale = this.config.scale;

            // 渲染形状和文本
            let html = `<div class="pptx-slide-content" style="width:${width * scale / 9525}px;height:${height * scale / 9525}px;">`;

            // 渲染图片
            const blipNodes = doc.querySelectorAll('a:blip');
            blipNodes.forEach(blip => {
                const embedId = blip.getAttribute('r:embed');
                if (embedId && this.relations[embedId]) {
                    const target = this.relations[embedId].target;
                    const mediaPath = `ppt/${target.replace('../', '')}`;
                    const imgSrc = this.mediaFiles[mediaPath] || this._getDefaultImage();
                    const spNode = blip.closest('p:sp');
                    const x = spNode.getAttribute('x') || 0;
                    const y = spNode.getAttribute('y') || 0;
                    const cx = spNode.getAttribute('cx') || 0;
                    const cy = spNode.getAttribute('cy') || 0;

                    html += `<img src="${imgSrc}" class="pptx-image" style="position:absolute;left:${x * scale / 9525}px;top:${y * scale / 9525}px;width:${cx * scale / 9525}px;height:${cy * scale / 9525}px;"/>`;
                }
            });

            // 渲染文本
            const textNodes = doc.querySelectorAll('a:t');
            textNodes.forEach(textNode => {
                const text = textNode.textContent || '';
                const rNode = textNode.closest('a:r');
                const pNode = textNode.closest('a:p');
                const spNode = textNode.closest('p:sp');

                // 文本样式
                const rPr = rNode.querySelector('a:rPr');
                const fontSize = rPr ? rPr.getAttribute('sz') || '2400' : '2400';
                const fontColor = rPr ? this._getFontColor(rPr) : this.themeStyles['tx1'] || '#333333';
                const isBold = rPr && rPr.querySelector('a:b') ? 'font-weight:bold' : '';
                const isItalic = rPr && rPr.querySelector('a:i') ? 'font-style:italic' : '';

                // 文本位置
                const x = spNode.getAttribute('x') || 0;
                const y = spNode.getAttribute('y') || 0;

                html += `<div class="pptx-text" style="position:absolute;left:${x * scale / 9525}px;top:${y * scale / 9525}px;font-size:${fontSize * scale / 100}px;color:${fontColor};${isBold};${isItalic};">${text}</div>`;
            });

            html += '</div>';
            return html;
        }

        /**
         * 渲染所有幻灯片到容器
         */
        _renderSlides() {
            if (!this.container || this.slides.length === 0) return;

            // 清空容器
            this.container.innerHTML = '';

            // 渲染每个幻灯片
            this.slides.forEach((slide, index) => {
                const slideEl = document.createElement('div');
                slideEl.className = 'pptx-slide';
                slideEl.style.display = index === 0 ? 'block' : 'none';
                slideEl.style.width = this.config.width;
                slideEl.style.height = this.config.height;
                slideEl.innerHTML = slide.html;
                this.container.appendChild(slideEl);
            });
        }

        /**
         * 显示指定索引的幻灯片
         * @param {number} index - 幻灯片索引（从0开始）
         * @returns {boolean} 显示结果
         */
        showSlide(index) {
            if (index < 0 || index >= this.slides.length) {
                console.warn('[PPTXViewer] 幻灯片索引超出范围');
                return false;
            }

            // 更新当前索引
            this.currentSlideIndex = index;

            // 切换显示状态
            document.querySelectorAll('.pptx-slide').forEach((el, i) => {
                el.style.display = i === index ? 'block' : 'none';
            });

            return true;
        }

        /**
         * 显示下一张幻灯片
         * @returns {boolean} 显示结果
         */
        nextSlide() {
            return this.showSlide(this.currentSlideIndex + 1);
        }

        /**
         * 显示上一张幻灯片
         * @returns {boolean} 显示结果
         */
        prevSlide() {
            return this.showSlide(this.currentSlideIndex - 1);
        }

        /**
         * 获取幻灯片总数
         * @returns {number} 幻灯片数量
         */
        getSlideCount() {
            return this.slides.length;
        }

        /**
         * 获取当前幻灯片索引
         * @returns {number} 当前索引
         */
        getCurrentSlideIndex() {
            return this.currentSlideIndex;
        }

        /**
         * 初始化默认样式
         */
        _initStyles() {
            const styleEl = document.createElement('style');
            styleEl.textContent = `
                .pptx-slide {
                    position: relative;
                    overflow: hidden;
                    background-color: #ffffff;
                    margin: 0 auto;
                }
                .pptx-slide-content {
                    position: relative;
                    overflow: hidden;
                }
                .pptx-image {
                    object-fit: contain;
                    border: none;
                    outline: none;
                }
                .pptx-text {
                    margin: 0;
                    padding: 0;
                    line-height: 1.2;
                    white-space: nowrap;
                }
                .pptx-notes {
                    margin-top: 10px;
                    padding: 10px;
                    background-color: #f5f5f5;
                    border-radius: 4px;
                    font-size: 14px;
                    color: #666666;
                }
            `;
            document.head.appendChild(styleEl);
        }

        /**
         * 获取字体颜色
         * @param {Element} rPrNode - 文本样式节点
         * @returns {string} 颜色值
         */
        _getFontColor(rPrNode) {
            const solidFill = rPrNode.querySelector('a:solidFill');
            if (solidFill) {
                const srgbClr = solidFill.querySelector('a:srgbClr');
                if (srgbClr) return `#${srgbClr.getAttribute('val')}`;
                const schemeClr = solidFill.querySelector('a:schemeClr');
                if (schemeClr) return this.themeStyles[schemeClr.getAttribute('val')] || '#333333';
            }
            return this.themeStyles['tx1'] || '#333333';
        }

        /**
         * 获取默认图片占位符
         * @returns {string} 占位图Base64
         */
        _getDefaultImage() {
            return 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MDAiIGhlaWdodD0iMzAwIj48cmVjdCB3aWR0aD0iNTAwIiBoZWlnaHQ9IjMwMCIgZmlsbD0iI2Y1ZjVmNSIvPjx0ZXh0IHg9IjI1MCIgeT0iMTUwIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIHRleHQtYW5jaG9yPSJtaWRkbGUiIHN0cm9rZT0iIzY2NiIgc3Ryb2tlLXdpZHRoPSIyIj48dGV4dCB4PSIyNTAiIHk9IjE1MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udQtzaXplPSIxMiIgZmlsbD0iIzY2NiI+5Zu+5Lq65YqoPC90ZXh0PjwvdGV4dD48L3N2Zz4=';
        }

        /**
         * 计算 tint 颜色
         * @param {string} baseColor - 基础颜色
         * @param {string} tintValue - tint值（0-100000）
         * @returns {string} 计算后的颜色
         */
        _getTintedColor(baseColor, tintValue) {
            const tint = parseInt(tintValue) / 100000;
            const r = parseInt(baseColor.slice(1, 3), 16);
            const g = parseInt(baseColor.slice(3, 5), 16);
            const b = parseInt(baseColor.slice(5, 7), 16);
            const newR = Math.round(r + (255 - r) * tint);
            const newG = Math.round(g + (255 - g) * tint);
            const newB = Math.round(b + (255 - b) * tint);
            return `#${newR.toString(16).padStart(2, '0')}${newG.toString(16).padStart(2, '0')}${newB.toString(16).padStart(2, '0')}`;
        }
    }

    // 暴露全局API
    window.PPTX = {
        Presentation: PPTXPresentation,
        version: '3.3.0'
    };

    return PPTXPresentation;

}));
