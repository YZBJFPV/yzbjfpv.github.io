<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­¾åå¢™</title>
    <style>
        /* å…¨å±€é‡ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none; /* ç¦ç”¨é»˜è®¤è§¦æ§è¡Œä¸ºï¼Œæå‡ç”»å¸ƒå“åº” */
        }

        /* ========== åŠ¨æ€é‡‘æ²™èƒŒæ™¯ï¼ˆç¨³å®šåŠ è½½ï¼Œéçº¯è‰²é»„ï¼‰ ========== */
        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            position: relative;
            background: 
                /* æ·±çº¢åº•å¸ƒï¼Œè¡¬æ‰˜é‡‘æ²™ */
                linear-gradient(135deg, #7B0000 0%, #9B1111 50%, #7B0000 100%),
                /* é‡‘æ²™ç»†æ¡çº¹ç†ï¼ˆæ ¸å¿ƒï¼šæ¸å˜é»„é‡‘ï¼Œéçº¯è‰²ï¼‰ */
                repeating-linear-gradient(45deg, 
                    rgba(255, 215, 0, 0.06) 0px, 
                    rgba(255, 205, 0, 0.12) 1px, 
                    rgba(255, 215, 0, 0.08) 2px,
                    rgba(255, 190, 0, 0.1) 3px,
                    rgba(255, 215, 0, 0.06) 4px
                ),
                /* é‡‘æ²™å…‰æ³½æ¸å˜ï¼ˆæ¨¡æ‹ŸæµåŠ¨åå…‰ï¼‰ */
                linear-gradient(180deg, rgba(255, 225, 50, 0.05) 0%, rgba(255, 185, 0, 0.1) 100%),
                /* é‡‘æ²™å™ªç‚¹çº¹ç†ï¼ˆå¢åŠ è´¨æ„Ÿï¼Œéçº¯è‰²ï¼‰ */
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='30' height='30' viewBox='0 0 30 30'%3E%3Cpath fill='%23ffd700' fill-opacity='0.04' d='M5 5h20v20H5V5zm2 2h16v16H7V7z'%3E%3C/path%3E%3C/svg%3E");
            background-blend-mode: overlay, multiply, lighten, normal;
            background-size: 400% 400%, 12px 12px, 100% 100%, 30px 30px;
            animation: 
                bg-flow 18s ease-in-out infinite alternate,
                sand-texture-flow 28s linear infinite,
                sand-glow 10s ease-in-out infinite alternate;
        }

        /* é‡‘æ²™èƒŒæ™¯æµåŠ¨åŠ¨ç”» */
        @keyframes bg-flow {
            0% { background-position: 0% 0%, 0 0, 0 0, 0 0; }
            50% { background-position: 100% 100%, 0 0, 0 0, 0 0; }
            100% { background-position: 0% 100%, 0 0, 0 0, 0 0; }
        }

        /* é‡‘æ²™çº¹ç†ç¼“æ…¢ç§»åŠ¨åŠ¨ç”» */
        @keyframes sand-texture-flow {
            0% { background-position: 0% 0%, 0 0, 0 0, 0 0; }
            100% { background-position: 0% 0%, 40px 40px, 0 0, 30px 30px; }
        }

        /* é‡‘æ²™å…‰æ³½æ˜æš—æ³¢åŠ¨ */
        @keyframes sand-glow {
            0% { filter: brightness(1.0) contrast(1.2) saturate(1.1); }
            100% { filter: brightness(1.15) contrast(1.3) saturate(1.2); }
        }

        /* ========== ç”»å¸ƒå®¹å™¨ï¼ˆä¸é‡‘æ²™èƒŒæ™¯èåˆï¼‰ ========== */
        #canvas-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* 2Kåˆ†è¾¨ç‡ç”»å¸ƒï¼ˆç²¾è‡´è¾¹æ¡†ï¼Œé€‚é…è§¦æ§ï¼‰ */
        #signatureCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
            border: 5px solid;
            border-image: linear-gradient(135deg, #FFD700, #FFA500, #FFD700) 1;
            border-radius: 12px;
            background: rgba(90, 0, 0, 0.08);
            box-shadow: 0 0 100px rgba(255, 215, 0, 0.4), inset 0 0 50px rgba(255, 185, 0, 0.1);
        }

        /* ========== ä¼˜åŒ–ç‰ˆ"ç­¾åå¢™"æ–‡å­—ï¼ˆå¤§æ°”ç²¾è‡´ï¼Œå‘Šåˆ«ä¸‘é™‹ï¼‰ ========== */
        .title {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 6.5vw; /* èˆ’å±•ä¸æ‹¥æŒ¤ï¼Œé€‚é…æ‰€æœ‰è®¾å¤‡ */
            font-weight: 900;
            /* æ–‡å­—çº¢è‰²æ¸å˜ï¼ˆéçº¯è‰²ï¼Œæœ‰å±‚æ¬¡æ„Ÿï¼Œä¸åˆºçœ¼ï¼‰ */
            background: linear-gradient(135deg, #FF3333, #C90000, #9B0000);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent; /* å®ç°æ¸å˜æ–‡å­— */
            /* å¤šå±‚ç»†è…»é˜´å½±ï¼ˆå¤§æ°”ä¸æ‚ä¹±ï¼Œå‘¼åº”é‡‘æ²™èƒŒæ™¯ï¼‰ */
            text-shadow: 
                0 1px 2px rgba(0, 0, 0, 0.9),
                0 0 10px rgba(255, 51, 51, 0.8),
                0 0 20px rgba(201, 0, 0, 0.6),
                0 0 35px rgba(255, 215, 0, 0.4); /* é‡‘æ²™å…‰æ³½ç‚¹ç¼€ï¼Œæå‡åè°ƒæ„Ÿ */
            letter-spacing: 30px; /* å­—é—´è·èˆ’å±•ï¼Œæ›´æ˜¾å¤§æ°” */
            word-spacing: 10px;
            /* ä¼˜é€‰ç²¾è‡´ä¹¦æ³•å­—ä½“ï¼Œå…œåº•æ— è¡¬çº¿ï¼Œé¿å…å­—ä½“ä¸¢å¤±å˜ä¸‘ */
            font-family: "ZCOOL KuaiLe", "Ma Shan Zheng", "Noto Serif SC", "STKaiti", serif;
            text-align: center;
            padding: 20px 50px;
            border-radius: 25px;
            /* ç²¾è‡´èƒŒæ™¯ä¸è¾¹æ¡†ï¼Œä¸æŠ¢æ–‡å­—é£å¤´ */
            background-color: rgba(255, 215, 0, 0.06);
            border: 2px solid linear-gradient(135deg, #FFD700, #FFA500);
            box-shadow: 0 0 70px rgba(255, 215, 0, 0.25), inset 0 0 20px rgba(255, 185, 0, 0.08);
            z-index: 5;
            /* è½»å¾®å…‰æ³½åŠ¨ç”»ï¼Œæå‡é«˜çº§æ„Ÿï¼ˆä¸æ™ƒçœ¼ï¼Œæ¶¦ç‰©ç»†æ— å£°ï¼‰ */
            animation: title-glow 12s ease-in-out infinite alternate;
        }

        /* æ–‡å­—è½»å¾®å…‰æ³½æ³¢åŠ¨ï¼Œå¢åŠ çµåŠ¨æ„Ÿ */
        @keyframes title-glow {
            0% { filter: brightness(1.0) saturate(1.1); }
            100% { filter: brightness(1.1) saturate(1.2); }
        }

        /* ========== åŠŸèƒ½æŒ‰é’®ï¼ˆé‡‘æ²™è´¨æ„Ÿï¼Œä¸æ»‘äº¤äº’ï¼‰ ========== */
        .btn-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 15px;
        }

        /* è§¦å‘æŒ‰é’®ï¼ˆ...ï¼‰ä¼˜åŒ–ï¼Œé‡‘æ²™æ¸å˜ï¼Œéçº¯è‰²é»„ */
        .trigger-btn {
            width: 62px;
            height: 62px;
            font-size: 26px;
            font-weight: bold;
            color: #7B0000;
            background: linear-gradient(135deg, #FFD700, #FFED4F, #FFD700);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.9), inset 0 0 10px rgba(255, 185, 0, 0.5);
            transition: all 0.3s ease;
            touch-action: manipulation;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .trigger-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 0 35px #fff, 0 0 20px rgba(255, 215, 0, 1);
        }

        .trigger-btn:active {
            transform: scale(0.96);
        }

        /* åŠŸèƒ½æŒ‰é’®ç»„ï¼ˆä¼˜åŒ–å¼¹å‡ºåŠ¨ç”»ï¼Œæ›´ä¸æ»‘ï¼‰ */
        .btn-group {
            display: flex;
            gap: 15px;
            opacity: 0;
            pointer-events: none;
            transform: translateY(20px) scale(0.95);
            transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .btn-group.show {
            opacity: 1;
            pointer-events: all;
            transform: translateY(0) scale(1);
        }

        /* åŠŸèƒ½æŒ‰é’®ä¼˜åŒ–ï¼Œé‡‘æ²™æ¸å˜ï¼Œéçº¯è‰²é»„ */
        .func-btn {
            padding: 12px 28px;
            font-size: 16px;
            font-weight: bold;
            color: #7B0000;
            background: linear-gradient(135deg, #FFD700, #FFED4F);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8), inset 0 0 8px rgba(255, 185, 0, 0.4);
            transition: all 0.3s ease;
            touch-action: manipulation;
        }

        .func-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 0 30px #fff, 0 0 15px rgba(255, 215, 0, 1);
        }

        .func-btn:active {
            transform: scale(0.95);
        }

        /* æ¿€æ´»çŠ¶æ€æŒ‰é’®ï¼ˆæ·±é‡‘æ²™ï¼Œæ›´é†’ç›®ï¼Œéçº¯è‰²ï¼‰ */
        .func-btn.active {
            background: linear-gradient(135deg, #FFA500, #FFD700);
            box-shadow: 0 0 25px rgba(255, 165, 0, 0.9), inset 0 0 8px rgba(255, 140, 0, 0.5);
        }
    </style>
    <!-- å›½å†…BootCDNï¼Œç¨³å®šå¿«é€ŸåŠ è½½ -->
    <script src="https://cdn.bootcdn.net/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
</head>
<body>
    <!-- ä¼˜åŒ–ç‰ˆ"ç­¾åå¢™"ä¸‰å­—ï¼Œç²¾è‡´å¤§æ°” -->
    <h1 class="title">ç­¾åå¢™</h1>

    <div id="canvas-container">
        <canvas id="signatureCanvas" width="2560" height="1440"></canvas>
    </div>

    <div class="btn-container">
        <div class="btn-group" id="funcBtnGroup">
            <button class="func-btn" id="undoBtn">ğŸ”™ å›é€€</button>
            <button class="func-btn" id="eraserBtn">ğŸ§½ æ©¡çš®æ“¦</button>
            <button class="func-btn active" id="penBtn">âœï¸ é‡‘è‰²ç”»ç¬”</button>
            <button class="func-btn" id="saveBtn">ğŸ’¾ ä¿å­˜ç­¾åï¼ˆ2Kï¼‰</button>
        </div>
        <button class="trigger-btn" id="triggerBtn">...</button>
    </div>

    <script>
        // å…¨å±€å˜é‡ï¼ˆåŸç”ŸCanvasï¼Œç¨³å®šæ— å‘ï¼‰
        const canvas = document.getElementById('signatureCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let isEraserActive = false;
        let lastX = 0;
        let lastY = 0;
        const ERASER_SIZE = 30;
        const PEN_WIDTH_BASE = 15;
        const CANVAS_STORAGE_KEY = 'SimpleSignatureWall_CN';
        let historyStates = [];
        const HISTORY_LIMIT = 50;
        let isBtnGroupShow = false;

        // é¡µé¢åŠ è½½å®Œæˆåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initCanvasStyle();
            initEventListeners();
            loadFromLocalStorage();
            saveHistoryState();
        });

        /**
         * åˆå§‹åŒ–åŸç”ŸCanvasé‡‘è‰²æµæ²™ç”»ç¬”æ ·å¼ï¼ˆéçº¯è‰²é»„ï¼‰
         */
        function initCanvasStyle() {
            const penGradient = ctx.createLinearGradient(0, 0, 20, 20);
            penGradient.addColorStop(0, '#FFD700');
            penGradient.addColorStop(0.5, '#FFED4F');
            penGradient.addColorStop(1, '#FFA500');
            ctx.strokeStyle = penGradient;

            ctx.lineWidth = PEN_WIDTH_BASE;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.globalAlpha = 0.9;

            ctx.shadowColor = '#FFA500';
            ctx.shadowBlur = 8;
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;
        }

        /**
         * åˆå§‹åŒ–æ‰€æœ‰äº‹ä»¶ç›‘å¬
         */
        function initEventListeners() {
            // è§¦å‘æŒ‰é’®åˆ‡æ¢åŠŸèƒ½ç»„
            document.getElementById('triggerBtn').addEventListener('click', function() {
                isBtnGroupShow = !isBtnGroupShow;
                const funcGroup = document.getElementById('funcBtnGroup');
                isBtnGroupShow ? funcGroup.classList.add('show') : funcGroup.classList.remove('show');
            });

            // å›é€€æŒ‰é’®
            document.getElementById('undoBtn').addEventListener('click', undoLastAction);

            // æ©¡çš®æ“¦æŒ‰é’®
            document.getElementById('eraserBtn').addEventListener('click', function() {
                isEraserActive = true;
                this.classList.add('active');
                document.getElementById('penBtn').classList.remove('active');
                ctx.shadowColor = 'transparent';
                ctx.shadowBlur = 0;
                ctx.globalAlpha = 1;
            });

            // é‡‘è‰²ç”»ç¬”æŒ‰é’®
            document.getElementById('penBtn').addEventListener('click', function() {
                isEraserActive = false;
                this.classList.add('active');
                document.getElementById('eraserBtn').classList.remove('active');
                initCanvasStyle();
            });

            // ä¿å­˜æŒ‰é’®
            document.getElementById('saveBtn').addEventListener('click', function() {
                saveCanvasAsImage();
                isBtnGroupShow = false;
                document.getElementById('funcBtnGroup').classList.remove('show');
            });

            // é¼ æ ‡ç»˜åˆ¶äº‹ä»¶
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // è§¦æ§ç»˜åˆ¶äº‹ä»¶
            canvas.addEventListener('touchstart', handleTouchStart);
            canvas.addEventListener('touchmove', handleTouchMove);
            canvas.addEventListener('touchend', handleTouchEnd);

            // ç‚¹å‡»ç©ºç™½å¤„éšè—åŠŸèƒ½ç»„
            document.addEventListener('click', function(e) {
                const btnContainer = document.querySelector('.btn-container');
                if (!btnContainer.contains(e.target) && isBtnGroupShow) {
                    isBtnGroupShow = false;
                    document.getElementById('funcBtnGroup').classList.remove('show');
                }
            });

            // Xé”®è¿”å›
            document.addEventListener('keydown', function(e) {
                if (e.key.toLowerCase() === 'x') {
                    window.history.back();
                }
            });
        }

        /**
         * å¼€å§‹ç»˜åˆ¶
         */
        function startDrawing(e) {
            isDrawing = true;
            const [x, y] = getCanvasCoordinates(e);
            lastX = x;
            lastY = y;
        }

        /**
         * ç»˜åˆ¶è¿‡ç¨‹
         */
        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();

            const [x, y] = getCanvasCoordinates(e);
            ctx.beginPath();

            if (isEraserActive) {
                ctx.clearRect(x - ERASER_SIZE/2, y - ERASER_SIZE/2, ERASER_SIZE, ERASER_SIZE);
            } else {
                const randomWidth = PEN_WIDTH_BASE + (Math.random() * 2 - 1);
                const randomAlpha = 0.8 + Math.random() * 0.2;
                ctx.lineWidth = randomWidth;
                ctx.globalAlpha = randomAlpha;

                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
            }

            lastX = x;
            lastY = y;
        }

        /**
         * åœæ­¢ç»˜åˆ¶
         */
        function stopDrawing() {
            if (!isDrawing) return;
            isDrawing = false;
            saveHistoryState();
            saveToLocalStorage();
        }

        /**
         * è§¦æ§èµ·å§‹å¤„ç†
         */
        function handleTouchStart(e) {
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        /**
         * è§¦æ§ç§»åŠ¨å¤„ç†
         */
        function handleTouchMove(e) {
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        /**
         * è§¦æ§ç»“æŸå¤„ç†
         */
        function handleTouchEnd(e) {
            const mouseEvent = new MouseEvent('mouseup', {});
            canvas.dispatchEvent(mouseEvent);
        }

        /**
         * è·å–Canvasç›¸å¯¹åæ ‡
         */
        function getCanvasCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            let x, y;

            if (e.type.includes('touch')) {
                x = (e.touches[0].clientX - rect.left) * (canvas.width / rect.width);
                y = (e.touches[0].clientY - rect.top) * (canvas.height / rect.height);
            } else {
                x = (e.clientX - rect.left) * (canvas.width / rect.width);
                y = (e.clientY - rect.top) * (canvas.height / rect.height);
            }

            return [x, y];
        }

        /**
         * ä¿å­˜å†å²çŠ¶æ€
         */
        function saveHistoryState() {
            const canvasData = canvas.toDataURL('image/png');
            historyStates.push(canvasData);
            if (historyStates.length > HISTORY_LIMIT) {
                historyStates.shift();
            }
        }

        /**
         * å›é€€ä¸Šä¸€æ­¥
         */
        function undoLastAction() {
            if (historyStates.length <= 1) {
                alert('å·²ç»æ˜¯æœ€æ—©çš„ç­¾åå•¦ï¼');
                return;
            }

            historyStates.pop();
            const prevState = historyStates[historyStates.length - 1];

            const img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                saveToLocalStorage();
            };
            img.src = prevState;
        }

        /**
         * ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜
         */
        function saveToLocalStorage() {
            try {
                const canvasData = canvas.toDataURL('image/png');
                localStorage.setItem(CANVAS_STORAGE_KEY, canvasData);
                console.log('ç­¾åå·²è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°');
            } catch (e) {
                console.warn('æœ¬åœ°ä¿å­˜å¤±è´¥ï¼š', e);
                alert('æœ¬åœ°å­˜å‚¨ä¸è¶³ï¼Œç­¾åå¯èƒ½æ— æ³•ä¿å­˜ï¼');
            }
        }

        /**
         * ä»æœ¬åœ°ç¼“å­˜åŠ è½½
         */
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem(CANVAS_STORAGE_KEY);
                if (savedData) {
                    const img = new Image();
                    img.onload = function() {
                        ctx.drawImage(img, 0, 0);
                        historyStates = [savedData];
                        console.log('å·²åŠ è½½æœ¬åœ°ä¿å­˜çš„ç­¾å');
                    };
                    img.src = savedData;
                }
            } catch (e) {
                console.warn('åŠ è½½æœ¬åœ°ç­¾åå¤±è´¥ï¼š', e);
            }
        }

        /**
         * 2Kåˆ†è¾¨ç‡æˆªå›¾ä¸‹è½½
         */
        function saveCanvasAsImage() {
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'â³ æ­£åœ¨ä¿å­˜...';

            try {
                domtoimage.toPng(canvas, {
                    width: 2560,
                    height: 1440,
                    quality: 1.0,
                    bgcolor: 'rgba(90, 0, 0, 0.8)'
                }).then(function(dataUrl) {
                    const link = document.createElement('a');
                    link.download = `ç­¾åå¢™_${new Date().getTime()}_2K.png`;
                    link.href = dataUrl;
                    link.click();

                    saveBtn.disabled = false;
                    saveBtn.textContent = 'ğŸ’¾ ä¿å­˜ç­¾åï¼ˆ2Kï¼‰';
                    alert('ç­¾åæˆªå›¾å·²ä¸‹è½½ï¼ï¼ˆ2Kåˆ†è¾¨ç‡ï¼‰');
                }).catch(function(error) {
                    throw error;
                });
            } catch (e) {
                console.error('ä¿å­˜æˆªå›¾å¤±è´¥ï¼š', e);
                saveBtn.disabled = false;
                saveBtn.textContent = 'ğŸ’¾ ä¿å­˜ç­¾åï¼ˆ2Kï¼‰';
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
            }
        }
    </script>
</body>
</html>
