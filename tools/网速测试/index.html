<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no" />
<meta charset="UTF-8" />
<link rel="shortcut icon" href="favicon.ico">
<!-- 测速核心脚本 -->
<script type="text/javascript" src="测速模块.js"></script>
<!-- 引入Chart.js用于绘制速度曲线图 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
<script type="text/javascript">
function I(i){return document.getElementById(i);}
// 初始化测速对象
var s = new Speedtest(); 
// 配置测速参数（与核心模块适配）
s.setParameter("telemetry_level", "none"); // 关闭数据上报
s.setParameter("getIp_ispInfo", false);    // 不获取ISP信息
s.setParameter("time_dl_max", 8);          // 下载测试时长（秒）
s.setParameter("time_ul_max", 5);          // 上传测试时长（秒）
s.setParameter("count_dl", 10);            // 下载测试数据包数量
s.setParameter("count_ul", 8);             // 上传测试数据包数量

// 配色方案
const theme = {
    primary: 'rgba(6, 182, 212, 0.8)',    // 下载颜色
    secondary: 'rgba(16, 185, 129, 0.8)',  // 上传颜色
    dark: 'rgba(15, 23, 42, 0.9)',
    light: 'rgba(248, 250, 252, 0.9)',
    gray: 'rgba(100, 116, 139, 0.7)',
    bgGradient: 'linear-gradient(135deg, #0f172a 0%, #1e293b 100%)'
};

// 速度曲线数据存储（增加长度限制）
const speedData = {
    download: [], 
    upload: [],   
    time: [],     
    maxPoints: 50,       // 最大数据点数
    maxLength: 10000     // 最大像素长度限制（px）
};
let chartInstance = null; 
let testStartTime = null; 
let uiData = null;      // 存储UI展示数据

// 初始化速度曲线图
function initSpeedChart() {
    const ctx = I('speedChart').getContext('2d');
    const chartBg = ctx.createLinearGradient(0, 0, 0, 250);
    chartBg.addColorStop(0, 'rgba(15, 23, 42, 0.5)');
    chartBg.addColorStop(1, 'rgba(15, 23, 42, 0.9)');

    chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: '下载速度 (Mbps)',
                    data: [],
                    borderColor: theme.primary,
                    backgroundColor: 'rgba(6, 182, 212, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 0,
                    pointHoverRadius: 4,
                    pointHoverBackgroundColor: theme.primary
                },
                {
                    label: '上传速度 (Mbps)',
                    data: [],
                    borderColor: theme.secondary,
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 0,
                    pointHoverRadius: 4,
                    pointHoverBackgroundColor: theme.secondary,
                    hidden: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        color: theme.light,
                        font: { size: 12, family: 'Segoe UI, Roboto' }
                    }
                },
                tooltip: {
                    backgroundColor: theme.dark,
                    titleColor: theme.light,
                    bodyColor: theme.light,
                    borderColor: theme.primary,
                    borderWidth: 1,
                    padding: 10,
                    cornerRadius: 6,
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.raw.toFixed(2)}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { display: true, text: '测试时间 (秒)', color: theme.gray, font: { size: 11 } },
                    ticks: { color: theme.gray, font: { size: 10 } },
                    grid: { color: 'rgba(100, 116, 139, 0.1)' }
                },
                y: {
                    title: { display: true, text: '速度 (Mbps)', color: theme.gray, font: { size: 11 } },
                    ticks: { color: theme.gray, font: { size: 10 }, min: 0 },
                    grid: { color: 'rgba(100, 116, 139, 0.1)' },
                    suggestedMax: 100
                }
            },
            animation: { duration: 0 },
            interaction: {
                intersect: false,
                mode: 'index'
            },
            backgroundColor: chartBg
        }
    });
}

// 绘制仪表盘
function drawAdvancedMeter(c, value, maxValue, color, label) {
    const ctx = c.getContext("2d");
    const dp = window.devicePixelRatio || 1;
    const cw = c.clientWidth * dp;
    const ch = c.clientHeight * dp;
    const centerX = cw / 2;
    const centerY = ch / 2;
    const radius = Math.min(centerX, centerY) - 15;
    const startAngle = 1.3 * Math.PI;
    const endAngle = 2.7 * Math.PI;
    const angleRange = endAngle - startAngle;
    const valueRatio = Math.min(value / maxValue, 1);
    const currentAngle = startAngle + (valueRatio * angleRange);

    if (c.width !== cw || c.height !== ch) {
        c.width = cw;
        c.height = ch;
    } else {
        ctx.clearRect(0, 0, cw, ch);
    }

    // 背景圆环
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, startAngle, endAngle);
    ctx.strokeStyle = 'rgba(100, 116, 139, 0.2)';
    ctx.lineWidth = 12;
    ctx.lineCap = 'round';
    ctx.stroke();

    // 进度圆环
    const gradient = ctx.createLinearGradient(0, 0, cw, ch);
    gradient.addColorStop(0, color);
    gradient.addColorStop(1, shadeColor(color, -30));

    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, startAngle, currentAngle);
    ctx.strokeStyle = gradient;
    ctx.lineWidth = 12;
    ctx.lineCap = 'round';
    ctx.stroke();

    // 流光效果
    if (valueRatio > 0) {
        ctx.save();
        ctx.beginPath();
        const glowAngle = currentAngle - 0.1;
        const glowRadius = radius + 5;
        ctx.arc(centerX, centerY, glowRadius, glowAngle - 0.05, glowAngle + 0.05);
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
        ctx.lineWidth = 4;
        ctx.stroke();
        ctx.restore();
    }

    // 中心数值
    ctx.font = `bold ${ch * 0.2}px Segoe UI, Roboto`;
    ctx.fillStyle = theme.light;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    const displayValue = value > 0 ? value.toFixed(value < 10 ? 2 : 1) : '0.00';
    ctx.fillText(displayValue, centerX, centerY);

    // 单位标签
    ctx.font = `${ch * 0.08}px Segoe UI, Roboto`;
    ctx.fillStyle = theme.gray;
    ctx.fillText(label, centerX, centerY + (ch * 0.12));
}

// 调整颜色亮度
function shadeColor(color, percent) {
    const rgbaMatch = color.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*(\d+(\.\d+)?)\)/);
    if (!rgbaMatch) return color;
    
    let r = parseInt(rgbaMatch[1]);
    let g = parseInt(rgbaMatch[2]);
    let b = parseInt(rgbaMatch[3]);
    const a = rgbaMatch[4];

    r = Math.min(Math.max(Math.round(r * (100 + percent) / 100), 0), 255);
    g = Math.min(Math.max(Math.round(g * (100 + percent) / 100), 0), 255);
    b = Math.min(Math.max(Math.round(b * (100 + percent) / 100), 0), 255);

    return `rgba(${r}, ${g}, ${b}, ${a})`;
}

// 格式化数值显示
function formatValue(d) {
    d = Number(d);
    if (d < 10) return d.toFixed(2);
    if (d < 100) return d.toFixed(1);
    return d.toFixed(0);
}

// 更新速度曲线数据（增加长度限制）
function updateSpeedChart(type, value) {
    if (!chartInstance || !testStartTime) return;
    
    const currentTime = Math.round((Date.now() - testStartTime) / 1000);
    const datasetIndex = type === 'download' ? 0 : 1;

    // 检查并限制图表长度
    const canvas = I('speedChart');
    const ctx = canvas.getContext('2d');
    const textMetrics = ctx.measureText(speedData.time.map(t => `${t}s`).join(','));
    const currentWidth = textMetrics.width;

    // 超过最大长度时删除最早数据
    if (currentWidth > speedData.maxLength && speedData.time.length > 10) {
        speedData.time.shift();
        speedData.download.shift();
        speedData.upload.shift();
    }

    // 更新数据数组
    if (speedData.time.length === 0 || speedData.time[speedData.time.length - 1] !== currentTime) {
        speedData.time.push(currentTime);
        speedData[type].push(value);
        
        // 限制最大数据点
        if (speedData.time.length > speedData.maxPoints) {
            speedData.time.shift();
            speedData.download.shift();
            speedData.upload.shift();
        }
    } else {
        speedData[type][speedData[type].length - 1] = value;
    }

    // 更新图表
    chartInstance.data.labels = speedData.time.map(t => `${t}s`);
    chartInstance.data.datasets[datasetIndex].data = speedData[type];
    
    // 动态调整y轴最大值
    const allValues = [...speedData.download, ...speedData.upload].filter(v => v > 0);
    if (allValues.length > 0) {
        const maxValue = Math.max(...allValues);
        chartInstance.options.scales.y.suggestedMax = maxValue * 1.2;
    }
    
    // 上传测试时显示上传曲线
    if (type === 'upload') {
        chartInstance.data.datasets[1].hidden = false;
    }
    
    chartInstance.update('none');
}

// 更新UI显示
function updateUI(force) {
    if (!uiData && !force) return;
    
    drawAdvancedMeter(I('dlMeter'), uiData.dlStatus, 1000, theme.primary, '下载 (Mbps)');
    drawAdvancedMeter(I('ulMeter'), uiData.ulStatus, 500, theme.secondary, '上传 (Mbps)');
    drawAdvancedMeter(I('pingMeter'), uiData.pingStatus, 500, '#f59e0b', '延迟 (ms)');
    drawAdvancedMeter(I('jitterMeter'), uiData.jitterStatus, 100, '#ef4444', '抖动 (ms)');
    
    I('ipDisplay').textContent = `IP: ${uiData.clientIp || '获取中...'}`;
}

// 存储测试结果到本地存储
function saveTestResultToLocalStorage() {
    if (!uiData) return;
    
    const testResult = {
        timestamp: new Date().getTime(),
        datetime: new Date().toLocaleString(),
        downloadSpeed: uiData.dlStatus.toFixed(2),
        uploadSpeed: uiData.ulStatus.toFixed(2),
        ping: uiData.pingStatus.toFixed(0),
        jitter: uiData.jitterStatus.toFixed(0),
        ip: uiData.clientIp || '未知'
    };
    
    // 获取现有记录并限制数量
    let testHistory = JSON.parse(localStorage.getItem('speedTestHistory') || '[]');
    if (testHistory.length >= 100) {
        testHistory = testHistory.slice(-99); // 保留最新99条
    }
    
    testHistory.push(testResult);
    localStorage.setItem('speedTestHistory', JSON.stringify(testHistory));
    console.log('测试结果已保存到本地存储');
}

// 页面加载完成后初始化
window.onload = function() {
    initSpeedChart();
    
    // 初始化仪表盘
    drawAdvancedMeter(I('dlMeter'), 0, 1000, theme.primary, '下载 (Mbps)');
    drawAdvancedMeter(I('ulMeter'), 0, 500, theme.secondary, '上传 (Mbps)');
    drawAdvancedMeter(I('pingMeter'), 0, 500, '#f59e0b', '延迟 (ms)');
    drawAdvancedMeter(I('jitterMeter'), 0, 100, '#ef4444', '抖动 (ms)');
    
    // 绑定开始按钮事件
    const btn = I('startBtn');
    btn.addEventListener('click', function() {
        if (s.getState() === 3) {
            // 正在测试时点击则中止
            s.abort();
            btn.innerHTML = '<span>开始测速</span>';
        } else {
            // 开始新测试
            btn.className = 'running';
            btn.innerHTML = '<span>测试中...</span>';
            
            // 重置数据
            speedData.download = [];
            speedData.upload = [];
            speedData.time = [];
            chartInstance.data.labels = [];
            chartInstance.data.datasets.forEach(ds => ds.data = []);
            chartInstance.update('none');
            testStartTime = Date.now();
            
            // 开始测试
            s.start();
        }
    });
    
    // 测速更新回调（与核心模块适配）
    s.onupdate = function(data) {
        uiData = data;
        updateUI();
        
        // 更新曲线数据
        if (data.testState === 1) {
            // 下载测试
            updateSpeedChart('download', data.dlStatus);
        } else if (data.testState === 3) {
            // 上传测试
            updateSpeedChart('upload', data.ulStatus);
        }
    };
    
    // 测速结束回调
    s.onend = function(aborted) {
        const btn = I('startBtn');
        btn.className = '';
        btn.innerHTML = '<span>重新测速</span>';
        
        if (!aborted) {
            // 保存结果到本地存储
            saveTestResultToLocalStorage();
            
            // 高亮显示结果
            setTimeout(() => {
                const meters = ['dlMeter', 'ulMeter', 'pingMeter', 'jitterMeter'];
                meters.forEach(id => I(id).classList.add('highlight'));
                setTimeout(() => {
                    meters.forEach(id => I(id).classList.remove('highlight'));
                }, 1000);
            }, 300);
        }
    };
};
</script>
<style>
/* 基础样式 */
body {
    margin: 0;
    padding: 0;
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    color: #f8fafc;
    font-family: 'Segoe UI', Roboto, sans-serif;
    min-height: 100vh;
    padding-bottom: 30px;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 15px;
}

header {
    text-align: center;
    padding: 30px 0;
}

h1 {
    margin: 0;
    font-size: 2rem;
    background: linear-gradient(90deg, #06b6d4, #10b981);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
}

/* 按钮样式 */
#startBtn {
    background: linear-gradient(90deg, #06b6d4, #0ea5e9);
    border: none;
    color: white;
    padding: 12px 30px;
    border-radius: 30px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin: 20px auto;
    display: block;
}

#startBtn.running {
    background: linear-gradient(90deg, #f59e0b, #d97706);
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); }
    100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
}

/* 仪表盘容器 */
.meters-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 30px;
}

.meter-wrapper {
    position: relative;
    height: 200px;
}

.meter {
    width: 100%;
    height: 100%;
}

.meter.highlight {
    animation: glow 1s ease;
}

@keyframes glow {
    0% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0.5); }
    50% { box-shadow: 0 0 0 10px rgba(6, 182, 212, 0.2); }
    100% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0); }
}

/* 图表样式 */
.chart-container {
    width: 100%;
    height: 300px;
    margin-top: 20px;
    border-radius: 10px;
    overflow: hidden;
}

#speedChart {
    width: 100%;
    height: 100%;
}

/* IP显示 */
#ipDisplay {
    text-align: center;
    color: rgba(100, 116, 139, 0.9);
    margin: 10px 0;
    font-size: 0.9rem;
}

/* 响应式调整 */
@media (max-width: 768px) {
    .meters-container {
        grid-template-columns: 1fr;
    }
    
    .chart-container {
        height: 250px;
    }
}
</style>
</head>
<body>
    <div class="container">
        <header>
            <h1>网速测试工具</h1>
            <p id="ipDisplay">IP: 获取中...</p>
            <button id="startBtn"><span>开始测速</span></button>
        </header>
        
        <div class="meters-container">
            <div class="meter-wrapper">
                <canvas id="dlMeter" class="meter"></canvas>
            </div>
            <div class="meter-wrapper">
                <canvas id="ulMeter" class="meter"></canvas>
            </div>
            <div class="meter-wrapper">
                <canvas id="pingMeter" class="meter"></canvas>
            </div>
            <div class="meter-wrapper">
                <canvas id="jitterMeter" class="meter"></canvas>
            </div>
        </div>
        
        <div class="chart-container">
            <canvas id="speedChart"></canvas>
        </div>
    </div>
</body>
</html>
